{"version":3,"sources":["../src/Process.js"],"names":["renderProcess","NO_MATCH","processName","moduleName","isComposite","MODULE_REGEX","matchPath","path","m","exec","shortName","NOT_IMPLEMENTED","secret","Symbol","AutomatonEnv","React","createContext","inject","scope","injections","scopeKeys","i","length","name","prop","QueryDeclaration","result","query","undefined","Error","ProcessEntry","process","initProcess","ScopeClass","loadProcesses","initial","ctx","keys","processes","console","log","entry","Process","module","components","default","getLayout","currentState","layout","prototype","isReactComponent","component","setCurrentState","data","states","renderViewState","ViewComponent","inputSchema","InputSchema","initialData","schema","env","contextPath","state","applicationScope","userScope","auth","authentication","Layout","Scopes","Authentication","processEntry","stateData","startState","initialized","ensureInitialized","parent","currentObject","array","transition","current","args","Promise","resolve","action","TypeError"],"mappings":"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","file":"Process.js","sourcesContent":["import React from \"react\";\nimport {\n    get,\n    keys,\n    set\n} from \"mobx\";\n\nimport QueryDeclaration from \"./QueryDeclaration\";\nimport FormConfigProvider from \"domainql-form/lib/FormConfigProvider\";\nimport InputSchema from \"domainql-form/lib/InputSchema\";\nimport Authentication from \"./auth\";\nimport { configuration } from \"./configuration\";\n\nconst NO_MATCH = {\n    processName : null,\n    moduleName : null,\n    isComposite : null\n};\n\nconst MODULE_REGEX = /^\\.\\/(processes\\/(.*?)\\/(composites\\/)?)?(.*?).js$/;\n\nfunction matchPath(path)\n{\n    const m = MODULE_REGEX.exec(path);\n    if (!m)\n    {\n        return NO_MATCH;\n    }\n\n    return {\n        processName: m[2],\n        shortName: m[4],\n        isComposite: !!m[3]\n    }\n}\n\nconst NOT_IMPLEMENTED = { \"_\" : \"NOT_IMPLEMENTED\" };\n\nconst secret = Symbol(\"ProcessSecret\");\n\nexport const AutomatonEnv = React.createContext({\n    \"_\" : \"default context\"\n});\n\nfunction inject(scope, injections)\n{\n    //console.log(\"INJECTIONS\", injections);\n\n    const scopeKeys = keys(scope);\n\n    for (let i = 0; i < scopeKeys.length; i++)\n    {\n        const name = scopeKeys[i];\n\n        const prop = get(scope, name);\n        if (prop instanceof QueryDeclaration)\n        {\n            const result = injections[prop.query];\n            if (result === undefined)\n            {\n                throw new Error(\"Could not find query for prop '\" + name + \"'\");\n            }\n\n            //console.log(\"set\", name, \"to\", result);\n\n            set( scope, name, result);\n        }\n    }\n}\n\nfunction ProcessEntry(process)\n{\n    this.process = process;\n    this.initProcess = null;\n    this.ScopeClass = null;\n}\n\n/**\n * Loads the process scope, initProcess and components from the given initial data and webpack require context\n *\n * @param initial   initial data\n * @param ctx       webpack require context\n * \n * @return {{process: *, initProcess: *, ScopeClass: *}}    infrastructural process objects\n */\nfunction loadProcesses(initial, ctx)\n{\n    const keys = ctx.keys();\n\n    const processes = {  };\n\n    for (let i = 0; i < keys.length; i++)\n    {\n        const moduleName = keys[i];\n\n        const { processName, shortName, isComposite } = matchPath(keys[i]);\n\n        if (!processName)\n        {\n            continue;\n        }\n\n        console.log(\"loadProcesses\", { moduleName, processName, shortName, isComposite });\n\n        if (!shortName)\n        {\n            throw new Error(\"Module name '\" + keys[i] + \"' does not match \" + MODULE_REGEX);\n        }\n\n        //console.log(\"-- Process\", m[1]);\n\n        let entry = processes[processName];\n        if (!entry)\n        {\n            entry = new ProcessEntry(\n                new Process(processName)\n            );\n            processes[processName] = entry;\n        }\n\n        const module = ctx(moduleName);\n        if (isComposite)\n        {\n            //console.log(\"process\", process);\n            entry.process[secret].components[shortName] = module.default;\n        }\n        else\n        {\n            const { default: ScopeClass, initProcess } = module;\n\n            if (!initProcess)\n            {\n                throw new Error(\"No initProcess defined in \" + moduleName);\n            }\n\n            entry.ScopeClass = ScopeClass;\n            entry.initProcess = initProcess;\n        }\n    }\n    return processes;\n}\n\nfunction getLayout(process, currentState)\n{\n    const { layout } = process;\n\n    if (layout)\n    {\n        if (currentState !== undefined && layout.prototype.isReactComponent)\n        {\n            const component = layout[currentState];\n            if (component)\n            {\n                return component;\n            }\n        }\n        return layout;\n    }\n    return configuration().layout;\n}\n\nfunction setCurrentState(process, currentState)\n{\n    // directly access secret process data\n    const data = process[secret];\n\n    if (!data.states[currentState])\n    {\n        throw new Error(\"Could not find state '\" + currentState + \"' in Process '\" + process.name + \"'\");\n    }\n    data.currentState = currentState;\n}\n\nfunction renderViewState(currentState, process)\n{\n    // directly access secret process data\n    const data = process[secret];\n\n    setCurrentState(process, currentState);\n\n    const ViewComponent = data.components[currentState];\n\n    if (!ViewComponent)\n    {\n        throw new Error(\"No component '\" + currentState + \"' in process '\" + process.name)\n    }\n\n    const inputSchema = new InputSchema(initialData.schema);\n\n    const env = {\n        process,\n        contextPath: initialData.contextPath,\n        state: currentState,\n        scope: data.scope,\n        applicationScope: NOT_IMPLEMENTED,\n        userScope: NOT_IMPLEMENTED,\n        auth: authentication,\n        initialData\n    };\n\n    const Layout = getLayout(process, currentState);\n\n    //console.log(\"LAYOUT\", Layout);\n\n    return (\n        <AutomatonEnv.Provider\n            value={ env }\n        >\n            <FormConfigProvider\n                schema={ inputSchema }\n            >\n                <Layout\n                    env={ env }\n                >\n                    <ViewComponent\n                        env={ env }\n                    />\n                </Layout>\n            </FormConfigProvider>\n        </AutomatonEnv.Provider>\n    )\n}\n\nlet initialData, authentication;\n\n\nexport function renderProcess(initial, ctx, Scopes)\n{\n    initialData = initial;\n\n    const processName = initial.processName;\n    //console.log(\"RENDER\", processName);\n\n    const {\n        injections,\n    } = initial;\n\n    authentication = new Authentication(initialData.authentication);\n\n    const processes = loadProcesses(initial, ctx);\n\n    console.log(\"PROCESSES\", processes);\n    \n    const processEntry = processes[processName];\n\n    if (!processEntry)\n    {\n        throw new Error(\"Could not find process '\" + processName + \"'\");\n    }\n\n    console.log(\"PROCESS-ENTRY\", processEntry);\n\n    const { process, initProcess, ScopeClass } = processEntry;\n\n    // directly access secret process data\n    const data = process[secret];\n\n    let scope;\n    if (ScopeClass)\n    {\n        scope = new ScopeClass();\n        inject(scope, injections);\n    }\n    else\n    {\n        scope = null;\n    }\n\n    const stateData = initProcess(process, scope);\n\n    const currentState = stateData.startState;\n\n    data.startState = currentState;\n    data.states = stateData.states;\n    data.scope = scope;\n    data.initialized = true;\n\n    initialData = initial;\n\n    return renderViewState(currentState, process);\n}\n\nfunction ensureInitialized(process)\n{\n    if (!process[secret].initialized)\n    {\n        throw new Error(\"Process not initialized\");\n    }\n}\n\n/**\n * Process facade exposing a limited set of getters and methods as process API\n */\nexport class Process {\n    constructor(name, parent)\n    {\n        this[secret] = {\n            name,\n            components: {},\n\n            parent,\n\n            states: null,\n            startState: null,\n\n            currentState: null,\n            currentObject: null,\n\n            scope: null,\n\n            layout: null,\n\n            initialized: false\n        };\n    }\n\n    get name()\n    {\n        return this[secret].name;\n    }\n    \n    get startState()\n    {\n        return this[secret].startState;\n    }\n\n    get states()\n    {\n        return this[secret].states;\n    }\n\n    get layout()\n    {\n        return this[secret].layout;\n    }\n\n    set layout(layout)\n    {\n        if (layout.prototype.isReactComponent || (layout && typeof layout === \"object\"))\n        {\n            this[secret].layout = layout;\n        }\n        else\n        {\n            throw new TypeError(\"Invalid layout: \" + layout);\n        }\n    }\n\n    getComponent(name)\n    {\n        const component = this[secret].components[name];\n        if (!component)\n        {\n            throw new Error(\"Could not find component '\" + name + \"'\");\n        }\n        return component;\n    }\n\n    transition(name, ... args)\n    {\n        ensureInitialized(this);\n\n        const data = this[secret];\n\n        const array = data.states[data.currentState];\n\n        let transition;\n\n        for (let i = 0; i < array.length; i++)\n        {\n            const current = array[i];\n\n            if (current.name === name)\n            {\n                 transition = current;\n                 break;\n            }\n        }\n\n        if (!transition)\n        {\n            throw new Error(\"Could not find transition '\" + name + \"' in Process '\" + this.name + \"'\" )\n        }\n\n        return Promise.resolve(transition.action(args));\n    }\n\n    back()\n    {\n        // TODO: implement\n    }\n}\n"]}