{"version":3,"sources":["../src/Process.js"],"names":["loadProcessDefinitions","fetchProcessInjections","ErrorView","onHistoryAction","renderProcess","renderSubProcess","getCurrentProcess","NO_MATCH","processName","moduleName","isComposite","MODULE_REGEX","matchPath","path","m","exec","shortName","secret","Symbol","AutomatonEnv","React","createContext","currentProcess","unlistenHistory","processes","navigationHistory","ProcessEntry","definition","initProcess","ScopeClass","processDefinitions","ctx","keys","i","length","Error","entry","ProcessDefinition","module","components","default","hasOwnProperty","processModule","name","getLayout","process","currentState","layout","options","prototype","isReactComponent","component","config","findRootProcess","asDialog","parent","findViewComponent","rootProcess","ViewComponent","createEnv","state","scope","renderCurrentView","Layout","env","dialogStack","subProcessEnv","SubProcessViewComponent","inputSchema","ensureInitialized","initialized","ensureNotInitialized","subProcessPromiseFns","subProcessPromise","PROCESS_DEFAULT_OPTIONS","forceSubProcess","Process","id","input","states","subProcessAsDialog","console","log","context","access","transition","Promise","resolve","action","executeTransition","to","then","pushProcessState","reject","appName","injections","err","element","result","catch","error","output","fns","startState","newOpts","TypeError","inject","scopeKeys","prop","QueryDeclaration","query","undefined","csrfToken","fetch","window","location","origin","method","credentials","headers","header","value","body","JSON","stringify","response","json","data","actionFn","target","viewModel","Transition","origScope","mobXActionKey","mobxAction","e","isCanceled","isDirty","submit","props","title","info","noViewState","navigationId","processId","getURIInfo","obj","replace","push","op","history","stateName","finishInitialization","Object","freeze","renderProcessInternal","asSubProcess","noPriorProcess","processesLen","newProcessId","slice","startTransitionName","String"],"mappings":"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","file":"Process.js","sourcesContent":["import React from \"react\";\nimport { createViewModel } from \"mobx-utils\";\nimport render from \"./render\";\nimport { action, get, keys, set } from \"mobx\";\n\nimport QueryDeclaration from \"./QueryDeclaration\";\nimport FormConfigProvider from \"domainql-form/lib/FormConfigProvider\";\nimport config from \"./config\";\nimport Transition from \"./Transition\";\nimport uri from \"./uri\";\nimport i18n from \"./i18n\";\nimport Dialog from \"./Dialog\";\n\n\nconst NO_MATCH = {\n    processName: null,\n    moduleName: null,\n    isComposite: null\n};\n\nconst MODULE_REGEX = /^\\.\\/(processes\\/(.*?)\\/(composites\\/)?)?(.*?).js$/;\n\n\n\nfunction matchPath(path)\n{\n    const m = MODULE_REGEX.exec(path);\n    if (!m)\n    {\n        return NO_MATCH;\n    }\n\n    return {\n        processName: m[2],\n        shortName: m[4],\n        isComposite: !!m[3]\n    }\n}\n\n\nconst secret = Symbol(\"ProcessSecret\");\n\nexport const AutomatonEnv = React.createContext({\n    \"_\": \"default context\"\n});\n\nlet currentProcess = null;\nlet unlistenHistory = null;\nlet processes = [];\n\nexport let navigationHistory = [];\n\n\nfunction ProcessEntry(definition)\n{\n    this.definition = definition;\n    this.initProcess = null;\n    this.ScopeClass = null;\n}\n\nconst processDefinitions = {};\n\n/**\n * Loads the process scope, initProcess and components from the given initial data and webpack require context\n *\n * @param ctx       webpack require context\n *\n * @return {{process: *, initProcess: *, ScopeClass: *}}    infrastructural process objects\n */\nexport function loadProcessDefinitions(ctx)\n{\n    const keys = ctx.keys();\n\n    //console.log(\"Modules: \", keys);\n\n    for (let i = 0; i < keys.length; i++)\n    {\n        const moduleName = keys[i];\n\n        const { processName, shortName, isComposite } = matchPath(keys[i]);\n\n        if (!processName)\n        {\n            continue;\n        }\n\n        //console.log(\"loadProcessDefinitions\", { moduleName, processName, shortName, isComposite });\n\n        if (!shortName)\n        {\n            throw new Error(\"Module name '\" + keys[i] + \"' does not match \" + MODULE_REGEX);\n        }\n\n        //console.log(\"-- Process\", m[1]);\n\n        let entry = processDefinitions[processName];\n        if (!entry)\n        {\n            entry = new ProcessEntry(\n                new ProcessDefinition(processName)\n            );\n            processDefinitions[processName] = entry;\n        }\n\n        const module = ctx(moduleName);\n        if (isComposite)\n        {\n            //console.log(\"process\", process);\n            entry.definition.components[shortName] = module.default;\n        }\n    }\n\n    for (let processName in processDefinitions)\n    {\n        if (processDefinitions.hasOwnProperty(processName))\n        {\n            const entry = processDefinitions[processName];\n\n            const path = \"./processes/\" + processName + \"/\" + processName + \".js\";\n            const processModule = ctx(path);\n            if (!processModule)\n            {\n                throw new Error(\"Could not find process exports module \" + path);\n            }\n\n            const { default: ScopeClass, initProcess } = processModule;\n\n            if (!initProcess)\n            {\n                throw new Error(\"No initProcess defined in \" + processName);\n            }\n\n            entry.name = processName;\n            entry.ScopeClass = ScopeClass;\n            entry.initProcess = initProcess;\n        }\n    }\n\n    return processDefinitions;\n}\n\n\nfunction getLayout(process, currentState)\n{\n    const { layout } = process.options;\n\n    if (layout)\n    {\n        // if layout is not a react component\n        if ((!layout.prototype || !layout.prototype.isReactComponent) && currentState)\n        {\n            // use it as lookup map\n            const component = layout[currentState];\n            if (component)\n            {\n                return component;\n            }\n\n            // we can't use the lookup map as react component, so we fall back to either\n            // the \"default\" layout in the lookup or the global default\n            return layout.default || config.layout\n        }\n        return layout;\n    }\n    return config.layout;\n}\n\n\nfunction findRootProcess(process)\n{\n    while (process && process[secret].options.asDialog)\n    {\n        process = process[secret].parent;\n    }\n    return process;\n}\n\n\nfunction findViewComponent(rootProcess)\n{\n    // directly access secret process data\n    const { definition, currentState } = rootProcess[secret];\n\n    //console.log({ definition, currentState });\n\n    const ViewComponent = definition.components[currentState];\n    if (!ViewComponent)\n    {\n        throw new Error(\"No component '\" + currentState + \"' in process '\" + rootProcess.name)\n    }\n\n    return ViewComponent;\n}\n\n\nfunction createEnv(process)\n{\n    return {\n        processName: process && process.name,\n        config: config,\n        state: process && process[secret].currentState,\n        scope: process && process.scope,\n        process: process\n    };\n}\n\n\nfunction renderCurrentView()\n{\n    const rootProcess = findRootProcess(currentProcess);\n\n    const ViewComponent = findViewComponent(rootProcess);\n    const Layout = getLayout(rootProcess, rootProcess[secret].currentState);\n\n    const env = createEnv(rootProcess);\n\n    let dialogStack = false;\n\n    let process = currentProcess;\n\n    while (process !== rootProcess)\n    {\n        const subProcessEnv = createEnv(process);\n        const SubProcessViewComponent = findViewComponent(process);\n\n        dialogStack = (\n            <Dialog process={ process }>\n                <AutomatonEnv.Provider\n                    value={ subProcessEnv }\n                >\n                    <SubProcessViewComponent env={ subProcessEnv }/>\n                    {\n                        dialogStack\n                    }\n                </AutomatonEnv.Provider>\n            </Dialog>\n        );\n\n        process = process[secret].parent;\n    }\n\n    return (\n        <AutomatonEnv.Provider\n            value={ env }\n        >\n            <FormConfigProvider\n                schema={ config.inputSchema }\n            >\n                <Layout\n                    env={ env }\n                >\n                    {\n                        ViewComponent && (\n                            <ViewComponent\n                                env={ env }\n                            />\n                        )\n                    }\n                </Layout>\n                {\n                    dialogStack\n                }\n            </FormConfigProvider>\n        </AutomatonEnv.Provider>\n    )\n}\n\n\nfunction ensureInitialized(process)\n{\n    if (!process[secret].initialized)\n    {\n        throw new Error(\"Process not initialized\");\n    }\n}\n\nfunction ensureNotInitialized(process)\n{\n    if (process[secret].initialized)\n    {\n        throw new Error(\"Process is already initialized\");\n    }\n}\n\nexport class ProcessDefinition {\n    constructor(name)\n    {\n        this.name = name;\n        this.components = {};\n    }\n}\n\n/**\n * Access the resolve and reject functions stored for a sub-process or throws an error when the process is not a sub-process\n *\n * @param process\n */\nfunction subProcessPromiseFns(process)\n{\n    const { subProcessPromise } = process[secret];\n\n    if (!subProcessPromise)\n    {\n        throw new Error(process[secret].name + \" was not invoked as sub-process\");\n    }\n    return subProcessPromise;\n}\n\nconst PROCESS_DEFAULT_OPTIONS = {\n\n    /**\n     * {React.Element|Object<React.Element>} layout component or map of layout components.\n     *\n     * If element, that element is used as layout for the process.\n     *\n     * If it is a map object, the view name will be used to look up the layout. If layout\n     * is registered for the view name, the `\"default\"` key is used. If neither is set,\n     * the global default layout used ( see config.js)\n     *\n     */\n    layout: null,\n\n    /**\n     * {boolean} true to open a sub-process as dialog\n     */\n    asDialog: true,\n\n    /**\n     * If `true` force the process to be used as a sub-process. Throw an error if it is used as root process.\n     */\n    forceSubProcess: false\n};\n\n/**\n * Process facade exposing a limited set of getters and methods as process API\n */\nexport class Process {\n    constructor(id, definition, scope, input, parent)\n    {\n        const { name } = definition;\n\n        this[secret] = {\n            id,\n            name,\n            definition,\n            input,\n            parent,\n            scope,\n\n            states: null,\n            currentState: null,\n\n            options: {\n                ... PROCESS_DEFAULT_OPTIONS,\n                asDialog:  parent ? config.subProcessAsDialog : false\n            },\n\n            subProcessPromise: null,\n\n            initialized: false\n        };\n\n        console.log(\"PROCESS '\" + name +\"'\", this);\n    }\n\n    get name()\n    {\n        return this[secret].name;\n    }\n\n\n    get startState()\n    {\n        return this[secret].startState;\n    }\n\n\n    get states()\n    {\n        return this[secret].states;\n    }\n\n\n    get scope()\n    {\n        return this[secret].scope;\n    }\n\n\n    get options()\n    {\n        return this[secret].options;\n    }\n\n\n    /**\n     * Merges the given object into the options object.\n     *\n     * @param {Object} newOpts   new options\n     */\n    set options(newOpts)\n    {\n        ensureNotInitialized(this);\n\n        if (!newOpts || typeof newOpts !== \"object\")\n        {\n            throw new Error(\"newOpts must be an map object\");\n        }\n\n        this[secret].options = {\n            ... this[secret].options,\n            newOpts\n        };\n    }\n\n    set layout(layout)\n    {\n        if ((layout.prototype && layout.prototype.isReactComponent) || (layout && typeof layout === \"object\"))\n        {\n            this[secret].layout = layout;\n        }\n        else\n        {\n            throw new TypeError(\"Invalid layout: \" + layout);\n        }\n    }\n\n    get input()\n    {\n        return this[secret].input;\n    }\n\n\n    /**\n     * Returns the composite component with the given name.\n     *\n     * @param name      composite name\n     * @return {?React.Element} composite component or null\n     */\n    getComponent(name)\n    {\n        const component = this[secret].components[name];\n        if (!component)\n        {\n            throw new Error(\"Could not find component '\" + name + \"'\");\n        }\n        return component || null;\n    }\n\n\n    /**\n     * Executes the transition with the given name.\n     *\n     * @param name          transition name\n     * @param context       transition context object\n     * @return {Promise<any | never>}\n     */\n    transition(name, context)\n    {\n        //console.log(\"process.transition\" , name, context);\n\n        ensureInitialized(this);\n\n        const access = this[secret];\n\n        const transition = access.states[access.currentState][name];\n        if (!transition)\n        {\n            throw new Error(\"Could not find transition '\" + name + \"' in Process '\" + this.name + \"'\")\n        }\n\n        //console.log(\"TRANSITION\", transition);\n\n        return (\n            Promise.resolve(\n                transition.action ?\n                    executeTransition(name, transition.action, transition.to, context) :\n                    transition.to\n            )\n                .then(currentState => {\n\n                    if (currentState)\n                    {\n                        access.currentState = currentState;\n                        pushProcessState();\n                    }\n\n                    return render(\n                        renderCurrentView(currentState)\n                    )\n                })\n        );\n    }\n\n\n    back()\n    {\n        // TODO: implement\n    }\n\n\n    /**\n     * Runs the process with the given name as sub-process.\n     *\n     * @param {String} processName     process name\n     * @param {Object} [input]         input object for the sub-process\n     *\n     * @return {Promise<any>} resolves to the sub-process result or is rejected when the sub-process is aborted.\n     */\n    runSubProcess(processName, input)\n    {\n        // create new promise that will resolve when the sub-process ends\n        return new Promise(\n            (resolve, reject) => fetchProcessInjections(config.appName, processName, input)\n                .then(injections => {\n\n                    //console.log(\"INJECTIONS\", injections);\n\n                    return (\n                        renderSubProcess(processName, input, injections.injections)\n                    );\n                }, err => <ErrorView title=\"Error starting Process\" info={ err } />)\n                .then(element => {\n\n                    //console.log(\"RENDER SUB-PROCESS VIEW\", elem);\n\n                    // store for subProcessPromiseFns\n                    const access = currentProcess[secret];\n                    access.subProcessPromise = {\n                        resolve,\n                        reject\n                    };\n\n                    return render(element);\n                })\n        )\n        .then(result => {\n\n            pushProcessState();\n\n            return render(\n                renderCurrentView()\n            )\n            // make sure to resolve the sub-process result only after the parent view is restored.\n            .then( () => result);\n        })\n        .catch(err => console.error(\"ERROR IN SUB-PROCESS\", err))\n    }\n\n\n    /**\n     * Ends the sub-process successfully and returns the given output object\n     * @param {*} [output]      sub-process output object\n     */\n    endSubProcess(output)\n    {\n        const fns = subProcessPromiseFns(this);\n\n        currentProcess = this[secret].parent;\n\n        fns.resolve(output);\n    }\n\n\n    /**\n     * Aborts the sub-process with an error object\n     *\n     * @param {*} [err]     error object\n     */\n    abortSubProcess(err)\n    {\n        subProcessPromiseFns(this).reject(err);\n    }\n\n}\n\n\nfunction inject(scope, injections)\n{\n    //console.log(\"INJECTIONS\", injections);\n\n    const scopeKeys = keys(scope);\n\n    for (let i = 0; i < scopeKeys.length; i++)\n    {\n        const name = scopeKeys[i];\n\n        const prop = get(scope, name);\n        if (prop instanceof QueryDeclaration)\n        {\n            const result = injections[prop.query];\n            if (result === undefined)\n            {\n                throw new Error(\"Could not find query for prop '\" + name + \"'\");\n            }\n\n            //console.log(\"inject\", name, \"with\", result);\n\n            set(scope, name, result);\n        }\n    }\n}\n\n\nexport function fetchProcessInjections(appName, processName, input = {})\n{\n    //console.log(\"fetchProcessInjections\", { appName, processName, input });\n\n    const { csrfToken } = config;\n\n    return fetch(\n        window.location.origin + uri(\"/_auto/process/{appName}/{processName}\", {\n                                   appName,\n                                   processName\n                               }),\n        {\n            method: \"POST\",\n            credentials: \"same-origin\",\n            headers: {\n                \"Content-Type\": \"text/plain\",\n\n                // spring security enforces every POST request to carry a csrf token as either parameter or header\n                [csrfToken.header]: csrfToken.value\n            },\n            body: JSON.stringify(input)\n        }\n    )\n        .then(response => response.json())\n        .then(\n            (data) => {\n                if (data.error)\n                {\n                    return Promise.reject(data.error);\n                }\n                return data;\n            }\n        )\n        .catch(err => {\n            console.error(\"ERROR FETCHING PROCESS INJECTIONS\", err)\n\n            return Promise.reject(err);\n        });\n}\n\n\n/**\n * Executes the given transition action function\n *\n * @param {String} name                     Transition name\n * @param {Function<Transition>} actionFn   Transition action function\n * @param {String} [target]                 transition target\n * @param {object} [context]                domain object context\n * @return {Promise<any | never>}\n */\nfunction executeTransition(name, actionFn, target, context)\n{\n    let viewModel;\n    const transition = new Transition(currentProcess, currentProcess[secret].currentState, target, context);\n\n    const access = currentProcess[secret];\n    const origScope = access.scope;\n    if (origScope)\n    {\n        viewModel = createViewModel(origScope);\n        access.scope = viewModel;\n    }\n\n    const mobXActionKey = \"mobxAction-\" + name;\n\n    let mobxAction = currentProcess[secret][mobXActionKey];\n    if (!mobxAction)\n    {\n        mobxAction = action(\n            currentProcess.name + \".\" + name,\n            actionFn\n        );\n        currentProcess[secret][mobXActionKey] = mobxAction;\n    }\n\n    return new Promise(\n        (resolve, reject) => {\n            try\n            {\n                resolve(\n                    mobxAction(\n                        transition\n                    )\n                );\n            }\n            catch (e)\n            {\n                reject(e);\n            }\n        }\n    )\n        .then(\n            () => {\n\n                if (!transition.isCanceled)\n                {\n                    if (origScope)\n                    {\n                        if (viewModel.isDirty)\n                        {\n                            viewModel.submit();\n                        }\n                        access.scope = origScope;\n                    }\n\n                    return transition.target\n                }\n            }\n        )\n        .catch(\n            err => {\n                if (origScope)\n                {\n                    access.scope = origScope;\n                }\n                console.error(\"ERROR IN TRANSITION\", err);\n            }\n        );\n}\n\n\nexport function ErrorView(props)\n{\n    const {title, info} = props;\n\n    const Layout = config.layout;\n\n    return (\n        <Layout env={ createEnv(null) }>\n            <div className=\"row\">\n                <div className=\"col\">\n                    <div className=\"alert alert-secondary\">\n                        <h3>\n                            {\n                                title\n                            }\n                        </h3>\n                        <hr/>\n                        <p className=\"text-muted\">\n                            {\n                                info\n                            }\n                        </p>\n                    </div>\n                </div>\n            </div>\n        </Layout>\n    )\n\n}\n\nfunction noViewState()\n{\n    return (\n        <ErrorView\n            title={ i18n(\"View State Gone\") }\n            info={ i18n(\"View State Gone Desc\") }\n        />\n    );\n}\n\n\nexport function onHistoryAction(location, action)\n{\n    const {state} = location;\n    if (action === \"POP\")\n    {\n        if (state)\n        {\n            //console.log(\"POP\", state);\n\n            const { navigationId } = state;\n            const entry = navigationHistory[navigationId];\n\n            if (!entry)\n            {\n                render(\n                    noViewState()\n                )\n            }\n\n            const { processId, currentState } = entry;\n\n            currentProcess = processes[processId];\n\n            currentProcess[secret].currentState = currentState;\n\n            render(\n                renderCurrentView()\n            )\n        }\n        // else\n        // {\n        //     console.log(\"POP no state\");\n        // }\n    }\n}\n\n\nfunction getURIInfo(obj)\n{\n    /// XXX: info?\n    return \"\";\n}\n\n\nfunction pushProcessState(replace = false)\n{\n    const { id, currentState } = currentProcess[secret];\n\n    const navigationId = navigationHistory.length;\n\n    navigationHistory.push({\n        processId: id,\n        currentState\n    });\n\n    const op = replace ? \"replace\" : \"push\";\n\n    //console.log(\"pushProcessState\", op);\n\n    config.history[op](\n        uri(\"/{appName}/{processName}/{stateName}/{info}\",\n            {\n                appName: config.appName,\n                processName: currentProcess.name,\n                stateName: currentState,\n                info: getURIInfo()\n            }, true), {\n            navigationId\n        });\n}\n\n\nfunction finishInitialization(process)\n{\n    //console.log(\"finishInitialization\", process.name);\n\n    const access = process[secret];\n    const { options } = access;\n\n    const keys = Object.keys(options);\n\n    for (let i = 0; i < keys.length; i++)\n    {\n        if (!PROCESS_DEFAULT_OPTIONS.hasOwnProperty(keys[i]))\n        {\n            throw new Error(\"'\" + process.name + \": '\" + name + \"' is not a valid process option\");\n        }\n    }\n\n    access.options = Object.freeze(options);\n    access.initialized = true;\n}\n\n\n/**\n * Internal process render start function\n *\n * @param {String} processName      process name\n * @param {object} input            input map\n * @param {object} injections       injections maps\n * @param {boolean} asSubProcess    launch process as sub-process\n * @return {Promise<React.Element>}\n */\nfunction renderProcessInternal(processName, input, injections, asSubProcess)\n{\n\n    let process;\n    let access;\n\n    const entry = processDefinitions[processName];\n    if (!entry)\n    {\n        throw new Error(\"Could not find process '\" + processName + \"'\");\n    }\n    //console.log(\"PROCESS-ENTRY\", entry);\n\n    const { initProcess, ScopeClass } = entry;\n\n    let scope;\n    if (ScopeClass)\n    {\n        scope = new ScopeClass();\n        inject(scope, injections);\n    }\n    else\n    {\n        scope = null;\n    }\n\n    const noPriorProcess = !currentProcess;\n    if (noPriorProcess)\n    {\n        if (asSubProcess)\n        {\n            throw new Error(\"Cannot launch sub-process without root process\");\n        }\n        config.rootProcess = processName;\n    }\n\n    const processesLen = processes.length;\n    let newProcessId = 0;\n    if (!noPriorProcess)\n    {\n        newProcessId = currentProcess[secret].id + 1;\n        if (newProcessId < processesLen)\n        {\n            // if we are inserting below the maximum available\n            processes = processes.slice(0, newProcessId);\n        }\n    }\n\n    process = new Process(newProcessId, entry.definition, scope, input, asSubProcess ? currentProcess : null);\n    processes.push(process);\n\n    access = process[secret];\n\n    return Promise.resolve(\n        initProcess(process, scope)\n    )\n        .then(\n            ({ startState, states }) => {\n\n                if (process.options.forceSubProcess && !asSubProcess)\n                {\n                    throw new Error(\"Process '\" + process.name + \"' must be run as sub-process\");\n                }\n\n                access.states = states;\n\n                finishInitialization(process);\n\n                currentProcess = process;\n\n                if (typeof startState === \"function\")\n                {\n                    const startTransitionName = process.name + \".start\";\n                    return executeTransition(\n                        startTransitionName,\n                        action(\n                            startTransitionName,\n                            startState\n                        )\n                    );\n                }\n                else\n                {\n                    return String(startState)\n                }\n            }\n        )\n        .then(\n            currentState => {\n\n                if (!currentState)\n                {\n                    throw new Error(\"No initial state\");\n                }\n                access.currentState = currentState;\n\n                pushProcessState(noPriorProcess);\n\n                return renderCurrentView();\n            }\n        )\n        .catch(err => {\n            console.error(\"ERROR IN START PROCESS\", err)\n            return (\n                <ErrorView\n                    title={ i18n(\"Process Startup Error \") }\n                    info={ String(err) }\n                />\n            );\n        })\n}\n\n/**\n * Starts a new root process and renders the first React element tree.\n * The states of the old root process remain in-memory for the user to navigate back.\n *\n * @param {String} processName      process name\n * @param {object} input            input data\n * @param {object} injections       injections for the process\n *\n * @return {Promise<React.Element>}   rendered elements of the first view.\n */\nexport function renderProcess(processName, input, injections)\n{\n    return renderProcessInternal(processName, input, injections, false)\n}\n\n\n/**\n * Starts the process with the given name as sub-process and renders the first React element tree.\n * Ending the subprocess will resume the parent process\n *\n * @param {String} processName      name of process to start as sub-process\n * @param {object} input            input data\n * @param {object} injections                injections for the sub-process\n *\n * @return {Promise<React.Element>}   rendered elements of the first view.\n */\nexport function renderSubProcess(processName, input, injections)\n{\n    return renderProcessInternal(processName, input, injections, true)\n}\n\nexport function getCurrentProcess()\n{\n    return currentProcess;\n}\n\n\n"]}